# ============================================================================
# Quantiloom - glTF PBR Test Configuration
# ============================================================================
# This configuration loads a glTF 2.0 model with full PBR material support
# ============================================================================

[renderer]
resolution = [1280, 1280]      # Output resolution
spp = 16                        # Samples per pixel (M1: single sample)
output = "gltf_pbr_output.exr" # Output file path (OpenEXR format)
environment_map = "D:/Quantiloom-Qt/assets/maps/qwantani_noon_puresky_4k.exr"  # EXR environment map

[spectral]
# ============================================================================
# Spectral Rendering Mode
# ============================================================================
# WARNING: "single", "mwir_fused", "lwir_fused", and "swir_fused" modes
#          are PREVIEW ONLY when no measured spectral curves are provided.
# ============================================================================
# These modes use RGB-averaged spectral albedo, NOT physically measured
# spectral reflectance. They are intended for VISUALIZATION ONLY.
# DO NOT use for quantitative analysis or scientific measurements.
#
# For quantitative results, provide measured spectral curves via [spectral_curves].
# ============================================================================
# Available modes:
#   - "rgb_fused"    : RGB rendering with full color (preview quality)
#   - "single"       : Single wavelength grayscale (PREVIEW ONLY, not quantitative)
#   - "swir_fused"   : Short-wave IR fusion 1-2.5μm (PREVIEW ONLY, not quantitative)
#   - "mwir_fused"   : Mid-wave IR fusion 3-5μm (PREVIEW ONLY, not quantitative)
#   - "lwir_fused"   : Long-wave IR fusion 8-12μm (PREVIEW ONLY, not quantitative)
# ============================================================================
mode = "rgb_fused"                   # RGB mode for full color rendering
#wavelength_nm = 550.0          # Target wavelength (nm) for single/IR modes

# Available basis files:
#   - "quantiloom_basis_v3_usgs.qlbin" : USGS data source, VIS/NIR/SWIR only
#   - "quantiloom_basis_v3_rii.qlbin" : RefractiveIndex.info data source, VIS/NIR/SWIR/MWIR/LWIR included
# Available materials files:
#   - "quantiloom_materials_usgs.json" : USGS data source, VIS/NIR/SWIR only
#   - "quantiloom_materials_rii.json" : RefractiveIndex.info data source, VIS/NIR/SWIR/MWIR/LWIR included
basis_file = "D:/Quantiloom-Qt/assets/spectral/quantiloom_basis_v3_usgs.qlbin"
materials_json = "D:/Quantiloom-Qt/assets/spectral/quantiloom_materials_usgs.json"
band = "VIS"  # or "NIR", "SWIR", "MWIR", "LWIR"

[scene]
# ============================================================================
# glTF Model Path
# ============================================================================
# Specify the path to your glTF file (.gltf or .glb)
# Examples:
#   gltf = "assets/models/glTF-Sample-Assets/Models/DamagedHelmet/glTF-Embedded/DamagedHelmet.gltf"
#   gltf = "assets/models/glTF-Sample-Assets/Models/MetalRoughSpheres/glTF-Embedded/MetalRoughSpheres.gltf"
#   gltf = "assets/models/glTF-Sample-Assets/Models/BoxTextured/glTF-Embedded/BoxTextured.gltf"
# ============================================================================
gltf = "D:/Quantiloom-Qt/assets/models/glTF-Sample-Assets/Models/DamagedHelmet/glTF/DamagedHelmet.gltf"
world_units_to_meters = 1.0  # 1.0=m, 0.01=cm, 0.001=mm

# ============================================================================
# Alternative: Use procedural preset (comment out 'gltf' above to use preset)
# ============================================================================
# preset = "cornell_box"       # Options: "cornell_box", "multi_object", "lighting_test"

[camera]
# Camera setup for viewing the glTF model
# Adjust position and look_at based on your model's size and location
position = [0.0, 0.0, 3.0]     # Camera position (world space, meters)
look_at = [0.0, 0.0, 0.0]      # Look-at target (usually model center)
up = [0.0, 1.0, 0.0]           # Up vector (Y-up coordinate system)
fov_y = 45.0                   # Vertical field of view (degrees)

[lighting]
# ============================================================================
# Lighting Configuration
# ============================================================================
# Sun: directional light source (Cook-Torrance specular highlights)
# Sky: ambient hemispherical lighting (diffuse approximation)
# ============================================================================
sun_direction = [0.5, 0.8, 0.3]   # FROM surface TO sun (normalized automatically)
sun_radiance = [5.0, 5.0, 5.0]    # Sun radiance (RGB, averaged to spectral scalar)
sky_radiance = [0.5, 0.7, 1.0]    # Sky radiance (RGB, averaged to spectral scalar)
#solar_lut = "assets/luts/modtran/AM1.0_VIS23.txt"   # Solar LUT for MODTRAN, if not povided, will use sun_radiance and sky_radiance as fallback
atmosphere_temperature_k = 260.0  # 240K: Plateaus, dry cold sky. 260K: Default sky. 280K: Warm sky. 290K: Tropical humid sky.

[material]
# Fallback material for procedural geometry (not used for glTF models)
albedo = [0.8, 0.8, 0.8]

# ============================================================================
# Quality Control (for HS-OFF / quantitative modes)
# ============================================================================
[quality]
# Enforce spectral data validation for HS-OFF mode (R5 risk mitigation)
# If true, rendering will abort if RGB-upsampled materials are detected
fail_on_srgb_upsample = false     # Set to true for strict quantitative mode
log_material_sources = true       # Log spectral source for each material

# ============================================================================
# Spectral Curves for Quantitative Rendering (HS-OFF Mode)
# ============================================================================
# Map glTF material names to measured spectral reflectance CSV files.
# Format: "MaterialName" = "path/to/reflectance.csv"
#
# CSV format (wavelength_nm, reflectance):
#   380.0, 0.05
#   390.0, 0.06
#   ...
#   780.0, 0.12
#
# Example:
# [spectral_curves]
# "Material.001" = "assets/spectra/aluminum_reflectance.csv"
# "Glass_Material" = "assets/spectra/glass_reflectance.csv"
#
# NOTE: The material name must match the glTF material name exactly.
#
# NOTE: If a material is not listed here, it will use RGB→Spectrum upsampling
# (approximate, not physically accurate). For quantitative rendering (HS-OFF),
# ALL materials should have measured spectral curves.
# ============================================================================
# [spectral_curves]
# Uncomment and add your material mappings here

# ============================================================================
# Complex Refractive Index for Physical Fresnel (Metal Materials)
# ============================================================================
# Map glTF material names to RefractiveIndex.INFO YAML files for accurate
# wavelength-dependent Fresnel reflectance on metal surfaces.
#
# Data source: https://refractiveindex.info/
# Download YAML files from the database and place in assets/refractiveindex/
#
# Format: "MaterialName" = "path/to/material.yml"
#
# YAML file format (RefractiveIndex.INFO tabulated nk):
#   DATA:
#     - type: tabulated nk
#       data: |
#           0.5000 0.9400 1.9600    # wavelength(µm) n k
#           0.5500 0.8800 2.2000
#           ...
#
# Example:
# [refractive_index]
# "Gold_Material" = "assets/refractiveindex/Au_Johnson.yml"
# "Silver_Material" = "assets/refractiveindex/Ag_Johnson.yml"
# "Copper_Material" = "assets/refractiveindex/Cu_Johnson.yml"
# "Aluminum_Material" = "assets/refractiveindex/Al_Rakic.yml"
#
# NOTE: The material name must match the glTF material name exactly.
#
# NOTE: If a material is not listed here, it will use standard PBR F0
# approximation: F0 = 0.04 + metallic * (baseColor - 0.04)
# For accurate metal rendering, provide measured n,k data.
# ============================================================================
# [refractive_index]
# Uncomment and add your material mappings here

# ============================================================================
# Sensor Simulation (Post-processing)
# ============================================================================
# Control whether to apply sensor effects to the rendered HDR output.
# If disabled, outputs the raw HDR radiance from the renderer (perfect output).
# If enabled, simulates realistic sensor characteristics (PSF blur, noise, ADC).
# ============================================================================
[sensor]
enabled = true                 # Set to true to enable sensor simulation

# Optics parameters (aggressive settings for demo)
focal_length_mm = 50.0          # Focal length (mm)
f_number = 11.0                 # Aperture (f-stop) - SMALL APERTURE = MORE DIFFRACTION BLUR
pixel_pitch_um = 5.0            # Pixel pitch (micrometers)

# Detector parameters (adjusted for better FPN visibility)
quantum_efficiency = 0.8        # QE at peak wavelength [0.0-1.0] - INCREASED for stronger signal
well_capacity_e = 50000.0       # Full well capacity (electrons)
read_noise_e_rms = 10.0         # Read noise (electrons RMS) - REDUCED for cleaner FPN pattern
dark_current_e_s = 50.0         # Dark current (electrons/second) - REDUCED
integration_time_s = 0.01       # Integration time (seconds) - INCREASED for stronger signal

# ADC parameters
bit_depth = 12                  # ADC bit depth (12/14/16) - LOWER BIT DEPTH = VISIBLE QUANTIZATION
gain = 5.0                      # Gain (electrons/DN) - HIGHER GAIN to avoid saturation

# Noise flags (all enabled for maximum realism)
enable_poisson_noise = true     # Shot noise (photon counting)
enable_read_noise = true        # Readout noise
enable_dark_current = true      # Dark current noise
enable_fpn = true                # Fixed pattern noise (PRNU/DSNU)

# FPN parameters (Fixed Pattern Noise) - Only used if enable_fpn = true
[sensor.fpn]
prnu_sigma = 0.03               # PRNU standard deviation (8% - STRONG but not saturating, realistic: 0.5-2%)
dsnu_sigma_e = 25.0             # DSNU standard deviation (30 e- - VISIBLE but not overwhelming, realistic: 5-20)
enable_nuc = false              # Apply NUC correction (leaves residual noise)
nuc_efficiency = 0.95           # NUC efficiency (95-99%, only used if enable_nuc = true)

# Temperature (for IR sensors)
detector_temperature_k = 77.0   # Detector temperature (K) for IR

# ============================================================================
# Multiband Fusion (Post-processing)
# ============================================================================
# Fuse VIS/SWIR/MWIR bands into a single enhanced grayscale/pseudocolor image.
# Requires rendering the same scene in multiple spectral modes.
# Output is for qualitative analysis (target detection), not quantitative.
# ============================================================================
[fusion]
# Fusion algorithm selection
# Options: "laplacian_pyramid", "weighted_average", "max_response", "pseudo_color"
method = "weighted_average"

# Auto-normalization (applies to all methods)
auto_normalize = true           # Normalize each band to [0, 1] before fusion

# Manual normalization ranges (used if auto_normalize = false)
vis_min = 0.0
vis_max = 1.0
swir_min = 0.0
swir_max = 1e-3
mwir_min = 0.0
mwir_max = 1e-2

# Laplacian Pyramid parameters (only used when method = "laplacian_pyramid")
[fusion.laplacian_pyramid]
levels = 5                      # Pyramid depth (4-6 recommended)

# Weighted Average parameters (only used when method = "weighted_average")
[fusion.weighted_average]
weight_vis = 0.4
weight_swir = 0.3
weight_mwir = 0.3

# Max Response - no additional parameters
[fusion.max_response]

# Pseudo Color - no additional parameters
[fusion.pseudo_color]

# Output paths (applies to all methods)
[fusion.output]
exr = "fused_vis_swir_mwir.exr"   # HDR output
png = "fused_vis_swir_mwir.png"   # LDR preview

# ============================================================================
# Atmospheric Scattering (Delta-Tracking Volumetric Rendering)
# ============================================================================
# Physical model for volumetric atmospheric scattering using Delta-Tracking.
# Supports wavelength-dependent Rayleigh + Mie scattering for realistic sky.
#
# PRESETS:
#   - "clear_day"      : Standard clear atmosphere (visibility ~23km)
#   - "hazy"           : Reduced visibility (~4.5km), more aerosol
#   - "polluted_urban" : Heavy pollution (~2km visibility)
#   - "mountain_top"   : Extremely clear (~90km visibility), thin atmosphere
#   - "mars"           : Martian dust atmosphere (CO2-dominated)
#   - "disabled"       : No atmospheric scattering (use for space scenes)
#
# CUSTOM PARAMETERS:
# You can override preset values by specifying them explicitly below.
# All parameters are optional; unspecified values use the preset defaults.
# ============================================================================
[atmospheric]
preset = "disabled"            # Use preset as base configuration

# Rayleigh scattering (molecular) - Optional overrides
rayleigh_enabled = true         # Enable Rayleigh scattering (O2, N2 molecules)
# rayleigh_beta_550nm = 5.8e-6  # Scattering coefficient at 550nm (m^-1)
# rayleigh_scale_height = 8500.0 # Scale height H_r (meters)

# Mie scattering (aerosol) - Optional overrides
mie_enabled = true              # Enable Mie scattering (dust, water droplets)
# mie_beta_550nm = 2.0e-6       # Scattering coefficient at 550nm (m^-1)
# mie_scale_height = 1200.0     # Scale height H_m (meters)
# mie_g = 0.76                  # Asymmetry parameter (0=isotropic, >0=forward)
# mie_alpha = 0.84              # Angstrom exponent (wavelength dependence)

# Planet geometry - Optional overrides
# planet_radius = 6.371e6       # Planet radius (meters, Earth: 6.371e6)
# atmosphere_height = 60000.0   # Atmosphere top (meters, typical: 60km)

# Delta-Tracking parameters - Optional overrides
# max_distance = 100000.0       # Maximum ray march distance (meters)
# max_steps = 64                # Maximum Delta-Tracking steps (32-128)
# extinction_threshold = 0.01   # Early termination threshold (transmittance < 1%)

# ============================================================================
# EXAMPLE: Disable atmospheric scattering for space scenes
# ============================================================================
# [atmospheric]
# preset = "disabled"

# ============================================================================
# EXAMPLE: Custom hazy urban scene
# ============================================================================
# [atmospheric]
# preset = "clear_day"
# mie_beta_550nm = 15.0e-6      # Override: heavy pollution
# mie_scale_height = 800.0      # Override: lower aerosol layer
